import json
from datetime import datetime
from rich.panel import Panel
from rich.table import Table
from rich.text import Text

# Block characters and growth zones
BLOCKS = "‚ñÅ‚ñÇ‚ñÉ‚ñÑ‚ñÖ‚ñÜ‚ñá‚ñà"
GROW_ZONES = [
    (2, "blue"),        # Seedling
    (5, "green"),       # Veg
    (8, "yellow"),      # Early Flower
    (12, "orange1"),    # Mid Flower
    (16, "red"),        # Late Flower
    (25, "magenta")     # Ripening / Finish
]

def grow_zone_color(week):
    for threshold, color in GROW_ZONES:
        if week <= threshold:
            return color
    return GROW_ZONES[-1][1]

def calc_progress(prop_date, repot_date=None):
    try:
        fmt = "%d/%m/%y"
        start = datetime.strptime(prop_date, fmt)
        now = datetime.now()
        total_weeks = 25
        elapsed_weeks = max(0, (now - start).days // 7)
        bar_len = min(elapsed_weeks, total_weeks)
        blocks = []
        for week in range(1, bar_len + 1):
            block_idx = min(int((week / total_weeks) * (len(BLOCKS) - 1)), len(BLOCKS) - 1)
            block = BLOCKS[block_idx]
            color = grow_zone_color(week)
            blocks.append(Text(block, style=color))
        bar = Text.assemble(*blocks)
        bar.append(f" {elapsed_weeks}w", style="bold white")
        return bar
    except Exception:
        return Text("[Invalid]", style="red")

def build_grow_panel():
    try:
        with open("plants.json", "r") as f:
            plants_data = json.load(f)
    except Exception as e:
        return Panel(f"[red]Error loading plants.json: {e}[/red]", title="üå± Grow Tracker", border_style="red")

    table = Table(title="[bold green]Grow Tracker[/bold green]", expand=True)
    table.add_column("Name", style="bold green", justify="left", no_wrap=True)
    table.add_column("Type", style="cyan", justify="center")
    table.add_column("Breeder", style="cyan", justify="center")
    table.add_column("Propergated", style="magenta", justify="center")
    table.add_column("Re-Potted", style="yellow", justify="center")
    table.add_column("Progress", style="white", justify="left")
    table.add_column("Watering Schedule", style="blue", justify="center")
    table.add_column("Height", style="green", justify="center")
    table.add_column("Harvest", style="bold yellow", justify="center")

    for entry in plants_data:
        name = f"[link=]{entry['name']}[/link]"
        type_ = entry.get("type", "Unknown")
        breeder = entry.get("breeder", "Unknown")
        prop_date = entry.get("propagation_date", "N/A")
        repot_date = entry.get("repot_date", "")
        progress = calc_progress(prop_date, repot_date)
        repot = repot_date if repot_date else "[Pending]"
        height_val = entry.get("height", 0.0)
        prev_val = entry.get("prev_height", 0.0)
        harvest_weight = entry.get("harvest_weight", 0.0)
        harvest = f"{harvest_weight:.1f}g" if harvest_weight else "[Pending]"

        # Simple height bar
        height_bar = f"{height_val:.1f}cm" if height_val else "[No data]"

        # Placeholder watering text
        watering = entry.get("watering", "[Unknown]")

        table.add_row(name, type_, breeder, prop_date, repot, progress, watering, height_bar, harvest)

    return Panel(table, border_style="grey37")

# Optional test render
if __name__ == "__main__":
    from rich.console import Console
    console = Console()
    panel = build_grow_panel()
    console.print(panel)

