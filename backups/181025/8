from rich.console import Console
from rich.panel import Panel
from rich.console import Group
from rich.table import Table
from rich.live import Live
import time
import board
import busio
from adafruit_as7341 import AS7341
import threading

# üß© Your custom modules only
from modules.as7341_sensor import init_as7341, create_as7341_cache, start_as7341_loop
from modules.as7341_panel import build_as7341_panel
from modules.watering import get_last_watered_text
from modules.dashboard_health import build_dashboard_health_panel
from modules.height import height_bar
from modules.moisture_chart import build_moisture_panel  # logging removed
from modules.system_panel import get_system_panel
from modules.i2c_panel import build_i2c_panel, scan_i2c_loop
from modules.performance_panels import (
    get_cpu_panel, get_memory_panel, get_disk_panel, get_network_panel
)
from modules.sensor_panels import build_sensor_cluster_panel
from modules.grow_tracker import build_grow_panel
from modules.watchdog_panel import WatchdogConfig, build_watchdog_log_panel, log_watchdog, watchdog_ping_loop

# üåê Console
console = Console()

# üåø Sensor Initialization
as7341 = init_as7341()
as7341_cache = create_as7341_cache()
start_as7341_loop(as7341, as7341_cache)

# üîÅ Refresh interval
REFRESH_INTERVAL = 1.0

# üß© Dashboard builder with config passed in
def build_dashboard(watchdog_config):
    layout = Table.grid(padding=(1, 2))

    layout.add_row(
        get_system_panel(),
        get_cpu_panel(),
        get_memory_panel(),
        get_disk_panel(),
        get_network_panel()
    )

    layout.add_row(
        build_i2c_panel(),
        build_dashboard_health_panel(console),
        build_watchdog_log_panel(watchdog_config),
        build_moisture_panel(),
        build_as7341_panel(as7341_cache)
    )

    layout.add_row(build_sensor_cluster_panel())

    # Separate layout for full-width panels
    grow_layout = Table.grid(padding=(1, 2))
    grow_layout.add_row(build_grow_panel())

    # Combine both layouts
    return Group(layout, grow_layout)

# üöÄ Dashboard runner
def run_dashboard():
    watchdog_config = WatchdogConfig()
    log_watchdog("‚úÖ Sentinel Echo initialized.", watchdog_config)

    threading.Thread(target=scan_i2c_loop, name="i2c_scan_loop", daemon=True).start()
    threading.Thread(target=watchdog_ping_loop, args=(watchdog_config,), name="watchdog_ping_loop", daemon=True).start()

    with Live(console=console, refresh_per_second=10, screen=True) as live:
        while True:
            live.update(build_dashboard(watchdog_config))
            time.sleep(REFRESH_INTERVAL)

# üß≠ Entry point
if __name__ == "__main__":
    run_dashboard()

