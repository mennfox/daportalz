from pyfiglet import Figlet
import os
import time
import threading
import subprocess
import json
JSON_FOLDER = os.path.join(os.path.dirname(__file__), "json")
from rich.console import Console, Group
from rich.panel import Panel
from rich.table import Table
from rich.text import Text
from rich.live import Live

import board
import busio
from adafruit_as7341 import AS7341

# üß© Custom Modules
from modules.as7341_sensor import init_as7341, create_as7341_cache, start_as7341_loop
from modules.as7341_panel import build_as7341_panel
from modules.watering import get_last_watered_text
from modules.dashboard_health import build_dashboard_health_panel
from modules.height import height_bar
from modules.tent_environment_panel import build_tent_environment_panel
from modules.scd4x_panel import build_scd4x_panel
from modules.system_panel import get_system_panel
from modules.i2c_panel import build_i2c_panel, scan_i2c_loop
from modules.grow_dashboard import build_grow_dashboard
from modules.watering_panel import build_watering_panel
from modules.performance_panels import (
    get_cpu_panel, get_memory_panel, get_disk_panel, get_network_panel
)
from modules.sensor_panels import build_sensor_cluster_panel
from modules.watchdog_panel import WatchdogConfig, build_watchdog_log_panel, log_watchdog, watchdog_ping_loop
from modules.get_top_process_panel import get_top_processes_panel  # ‚úÖ New panel
from modules.tent_heatmap_panel import get_tent_heatmap_panel
# üåê Console
console = Console()

# üåø Sensor Initialization
as7341 = init_as7341()
as7341_cache = create_as7341_cache()
start_as7341_loop(as7341, as7341_cache)

# üîÅ Refresh interval
REFRESH_INTERVAL = 1.0

# üåü Portal Invocation
def print_animated_banner(text="DaPortalZ", font="slant", delay=0.1):
    figlet = Figlet(font=font)
    banner_lines = figlet.renderText(text).splitlines()
    terminal_width = os.get_terminal_size().columns
    for line in banner_lines:
        padded_line = line.center(terminal_width)
        console.print(padded_line, style="bold cyan")
        time.sleep(delay)

# üß† Core System Panel (optional legacy block)
def build_main_system_panel():
    grid = Table.grid(padding=(1, 2))
    grid.add_row(get_system_panel(), get_cpu_panel(), get_memory_panel())
    grid.add_row(get_disk_panel(), get_network_panel(), get_i2c_panel())
    grid.add_row(get_watchdog_log_panel(), build_dashboard_health_panel(), build_averages_panel())
    return Panel(grid, title="üß† Core System Glyph", border_style="grey37")

# üß© Dashboard Builder
def build_dashboard(watchdog_config):
    layout = Table.grid(padding=(1, 2))

    system_grid = Table.grid(padding=(1, 2))
    system_grid.add_column()
    system_grid.add_column()
    system_grid.add_column()
    system_grid.add_column()

    # üß† Core Panels
    system_grid.add_row(
        get_system_panel(),
        get_cpu_panel(),
        build_dashboard_health_panel(console),
        build_tent_environment_panel()
    )

    system_grid.add_row(
        get_memory_panel(),
        get_disk_panel(),
        build_watchdog_log_panel(watchdog_config),
        build_sensor_cluster_panel()
    )

    system_grid.add_row(
        get_network_panel(),
        get_top_processes_panel(),  # ‚úÖ New panel added here
        build_i2c_panel(),
        build_as7341_panel(as7341_cache)
    )

    layout.add_row(system_grid)

    # üåø Grow Panels
    grow_layout = Table.grid(padding=(1, 2))
    grow_layout.add_row(build_grow_dashboard())
    grow_layout.add_row(build_watering_panel(show_panel=True))

    # üß¨ Combine Layouts
    return Group(layout, grow_layout)

# üöÄ Dashboard Runner
def run_dashboard():
    watchdog_config = WatchdogConfig()
    log_watchdog("‚úÖ Sentinel Echo initialized.", watchdog_config)

    threading.Thread(target=scan_i2c_loop, name="i2c_scan_loop", daemon=True).start()
    threading.Thread(target=watchdog_ping_loop, args=(watchdog_config,), name="watchdog_ping_loop", daemon=True).start()

    with Live(console=console, refresh_per_second=10, screen=True) as live:
        while True:
            live.update(build_dashboard(watchdog_config))
            time.sleep(REFRESH_INTERVAL)

# üß≠ Entry Point
if __name__ == "__main__":
    print_animated_banner()  # üåü Portal invocation
    run_dashboard()
